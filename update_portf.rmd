---
title: "Q2 Quant FIA"
author: "werleycordeiro@gmail.com"
date: "31/05/2020"
output: html_document
---

```{r setup, include=FALSE}
suppressMessages(library(httr))
suppressMessages(library(rvest))

Q2 = c("ELET6","PETR4","USIM5","CCRO3","GGBR4","BRDT3","MRVE3","BRML3","BBDC4","BTOW3","ibov")

q2f = matrix(c(0.200828,29.86,
0.168209,	19.76,
0.141667,	4.92,
0.116692,	14.59,
0.112401,	12.03,
0.073883,	21.71,
0.070604,	16.6,
0.062889,	10.05,
0.048958,	19.35,
0.00387,	94.36,
1.00000,85468.91),ncol=2,byrow=TRUE)

for(i in 1:length(Q2)){
	sh = GET(url = paste0("https://www.ibovx.com.br/historico-papeis-bovespa.aspx?papel=",Q2[i]))
	data = read_html(sh) %>% html_nodes("div") %>% html_nodes("table") %>% html_nodes("tr") %>% html_nodes("td") %>% html_text()
	if(i==1){
		aux = as.numeric(gsub(",",".",noquote(matrix(data[13:length(data)],ncol=9,byrow=TRUE)[2,4])))
	}else{
		if(i<length(Q2)){
			aux = c(aux,as.numeric(gsub(",",".",noquote(matrix(data[13:length(data)],ncol=9,byrow=TRUE)[2,4]))))
		}else{
		  if(i==length(Q2)){
		    aux = c(aux,as.numeric(sub(",","",noquote((matrix(data[13:length(data)],ncol=7,byrow=TRUE))[2,4])))*1000)
		  }
		}
	}
	pb = txtProgressBar(min = (1/length(Q2)), max = length(Q2), style = 3)
	setTxtProgressBar(pb,i)
}
q2f = cbind(q2f,matrix(aux,ncol=1,byrow=TRUE))

port = (sum(q2f[1:(length(Q2)-1),1]*q2f[1:(length(Q2)-1),3])-sum(q2f[1:(length(Q2)-1),1]*q2f[1:(length(Q2)-1),2]))/sum(q2f[1:(length(Q2)-1),1]*q2f[1:(length(Q2)-1),2])*100

ibov = ((q2f[length(Q2),1]*q2f[length(Q2),3])-(q2f[length(Q2),1]*q2f[length(Q2),2]))/(q2f[length(Q2),1]*q2f[length(Q2),2])*100

colnames(q2f) = c("Peso","P. Entrada 26/05/2020 ",paste0("P. Atual ",noquote((matrix(data[13:length(data)],ncol=7,byrow=TRUE))[2,1])))
rownames(q2f) = Q2

#q2f

results = matrix(round(c(port,ibov),2),2,1)
rownames(results) = c("Q2","Ibov")
colnames(results) = c("%")
#results
```
```{r}
q2f

results
```